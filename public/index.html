<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="mx-auto max-w-2xl p-6">
    <h1 class="text-2xl font-semibold text-center">Mini Chat</h1>

    <div class="mt-4 flex gap-2">
      <input id="user" class="flex-1 rounded-xl border border-slate-200 bg-white px-3 py-2 outline-none focus:ring"
             placeholder="Name" />
      <button id="connect" class="rounded-xl bg-slate-900 px-4 py-2 text-white transition hover:bg-slate-800 active:bg-slate-700">
        Connect
      </button>
    </div>

    <div id="log" class="mt-4 h-80 overflow-auto rounded-2xl border border-slate-200 bg-white p-3 text-sm"></div>

    <div class="mt-4 flex gap-2">
      <input id="msg" class="flex-1 rounded-xl border border-slate-200 bg-white px-3 py-2 outline-none focus:ring"
             placeholder="Message..." disabled />
      <button id="send" class="rounded-xl bg-blue-600 px-4 py-2 text-white disabled:opacity-50" disabled>
        Send
      </button>
    </div>
  </main>

  <script>
    const logEl = document.getElementById("log");
    const userEl = document.getElementById("user");
    const msgEl  = document.getElementById("msg");
    const connectBtn = document.getElementById("connect");
    const sendBtn = document.getElementById("send");

    let ws = null;
    let myName = "";

    const escapeHtml = (s) =>
      s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
       .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    const fmtTime = (iso) => {
      const d = new Date(iso);
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    };

    function line(html) {
      const div = document.createElement("div");
      div.className = "py-0.5";
      div.innerHTML = html;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setConnected(on) {
      msgEl.disabled = !on;
      sendBtn.disabled = !on;
      userEl.disabled = on;
      connectBtn.textContent = on ? "Disconnect" : "Connect";
      connectBtn.className = on
        ? "rounded-xl bg-slate-700 px-4 py-2 text-white"
        : "rounded-xl bg-slate-900 px-4 py-2 text-white";
    }

    connectBtn.addEventListener("click", () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
        return;
      }

      myName = userEl.value.trim();
      if (!myName) return alert("Enter a name");

      const proto = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${proto}://${location.host}/ws`);

      ws.addEventListener("open", () => {
        ws.send(JSON.stringify({ type: "join", user: myName }));
        setConnected(true);
        line(`<div class="text-slate-500">Connected as <b>${escapeHtml(myName)}</b></div>`);
        msgEl.focus();
      });

      ws.addEventListener("message", (ev) => {
        const m = JSON.parse(ev.data);
        const t = `<span class="mr-2 text-xs text-slate-400">${fmtTime(m.time)}</span>`;

        if (m.type === "join" || m.type === "leave") {
          line(`<div class="text-slate-500">${t}${escapeHtml(m.text)}</div>`);
          return;
        }

        const who = m.user === myName
          ? `<span class="font-semibold">${escapeHtml(m.user)}</span>`
          : `<span class="font-semibold text-slate-700">${escapeHtml(m.user)}</span>`;

        line(`<div>${t}${who}: ${escapeHtml(m.text)}</div>`);
      });

      ws.addEventListener("close", () => {
        line(`<div class="text-slate-500">Disconnected.</div>`);
        setConnected(false);
      });

      ws.addEventListener("error", () => {
        line(`<div class="text-red-600">WebSocket error.</div>`);
      });
    });

    function send() {
      const text = msgEl.value.trim();
      if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: "msg", text }));
      msgEl.value = "";
      msgEl.focus();
    }

    sendBtn.addEventListener("click", send);
    msgEl.addEventListener("keydown", (e) => e.key === "Enter" && send());
  </script>
</body>
</html>
